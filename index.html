<script>
    const map = L.map("map");

    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri'
    }).addTo(map);

    L.control.scale({ position: 'bottomright', metric: true, imperial: false }).addTo(map);

    // تحميل حدود المحافظات
    $.getJSON("GoverW.json", function(GW) {
        let goverLayer = L.geoJson(GW, {
            style: function(feature) {
                return {
                    fillColor: "",
                    fillOpacity: 0.0,
                    color: "black",
                    weight: 2,
                    opacity: 0.7
                };
            },
            onEachFeature: function(feature, layer) {
                layer.on('click', function(e) {
                    alert("Governorate: " + feature.properties.Name);
                });
            }
        }).addTo(map);
        map.fitBounds(goverLayer.getBounds());
    });

    // إعداد أيقونة موحدة
    const blueIcon = L.icon({
        iconUrl: 'blue.png',
        iconSize: [25, 32],
        iconAnchor: [10, 32],
        popupAnchor: [1, -34],
    });

    // تفاصيل جميع المواقع
    const siteDetails = {
        "BluElephant": {
            img: "BluElephant.png",
            text: "BluElephant is a compact Smart MBR system designed for decentralized municipal wastewater treatment . It serves 50–150 people/day (5–6 m³/day) with effluent suitable for irrigation. Featuring a small footprint, easy transport, plug-and-play setup, and minimal energy consumption, it offers a sustainable and efficient solution for wastewater management."
        },
        "Salfeet Municipality": {
            img: "Gis.png",
            text: "Geographic Information System (GIS) has been developed to enhance engineers' skills  and expertise in handling GIS technologies. The system integrates household subscription data and asset management according to established standards, improving operational efficiency and data-driven decision-making."
        },
        "Data collection for Iskaka village": {
            img: "Iskaka.png",
            text: "Collecting water network data for the village of Iskaka , including meters and water lines, using a surveying instrument involves a field survey with GPS, followed by data processing and analysis using GIS to create detailed maps and improve network management."
        },
        "Data collection for Farkha village": {
            img: "Farkha.png",
            text: "Collecting water network data for the village of Farkha , including meters and water lines, using a surveying instrument involves a field survey with GPS, followed by data processing and analysis using GIS to create detailed maps and improve network management."
        },
        "Flowless": {
            img: "flowless.jpg",
            text: "Flowless contributes to water sustainability and enhances resource management efficiency by integrating advanced technologies for real-time water network monitoring, controlling, and data analysis. Its smart system relies on IoT devices to collect data on flow, pressure, and quality, enabling early detection of leaks and potential risks."
        },
        "Purification station - Lab support": {
            img: "Lab.jpeg",
            text: "Lab support the lab in Salfit Waste water Treatment Plant  is doing all the tests that are needed to operate and evaluate the  wwtp in all treatment stages The support  from the dutch project was in term of development the quality of the lab relating to the sampling,tests ,handling with the sample ,troobleshooting the results and what the interpretation of each results to the plant .The support also included going to the quality control labs with Willi ,chanica and eddy in Jordan  and that  helped us in knowing and seeing the standard methods for the tests in wastewater labs and the ways of developing the quality in our labs."
        },
        "Hebron Project 1": {
            img: "bluhebron.jpeg",
            text: "Description for Hebron Project 1."
        },
        "Hebron Project 2": {
            img: "bluhebron.png",
            text: "Same lab support but for Hebron."
        }
    };

    const addedCoords = [];

    function addProjects(jsonFile) {
        $.getJSON(jsonFile, function(data) {
            L.geoJson(data, {
                pointToLayer: function(feature, latlng) {
                    const name = feature.properties.Name.trim(); // <-- هذا هو التعديل الأساسي
                    const details = siteDetails[name] || {
                        img: "default.jpg",
                        text: "لا توجد تفاصيل لهذا المشروع."
                    };

                    let newLatLng = latlng;
                    const offset = 0.0003;

                    while (addedCoords.some(coord => newLatLng.distanceTo(coord) < 10)) {
                        newLatLng = L.latLng(newLatLng.lat + offset, newLatLng.lng + offset);
                    }
                    addedCoords.push(newLatLng);

                    const marker = L.marker(newLatLng, { icon: blueIcon }).bindPopup(name);

                    marker.on('click', function () {
                        document.getElementById('info-title').innerText = name;
                        document.getElementById('info-img').src = details.img;
                        document.getElementById('info-text').innerText = details.text;
                        document.getElementById('info-box').style.display = 'block';

                        map.flyTo(newLatLng, 16, {
                            animate: true,
                            duration: 1.5
                        });
                    });

                    return marker;
                }
            }).addTo(map);
        });
    }

    // إضافة مشاريع سلفيت والخليل
    addProjects("SalfitProject.json");
    addProjects("LocationHebron.json");

    // تحريك الخريطة
    document.getElementById('left-button').addEventListener('click', function () {
        map.panBy([-150, 0]);
    });
    document.getElementById('right-button').addEventListener('click', function () {
        map.panBy([150, 0]);
    });

    // إغلاق صندوق المعلومات
    document.getElementById('close-btn').addEventListener('click', function () {
        document.getElementById('info-box').style.display = 'none';
    });
</script>
